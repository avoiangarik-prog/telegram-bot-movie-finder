# —Ç–≥ –±–æ—Ç 
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, ContextTypes, CallbackContext
#|–Ω–æ–≤–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞|...................................................................................................................
import os
import logging
import json
from urllib.request import Request, urlopen
from urllib.parse import urlencode
from telegram import Update, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
)
#|—Å—Ç–∞—Ä–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞|
# –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(name)
#//////////////////////////////////////////////////////////////////////////////////////////////////

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
KINOPOISK_API_KEY = os.getenv("79c50614-6417-4d98-ac80-b7b9915785d5")  # –í–∞—à API‚Äë–∫–ª—é—á –ö–∏–Ω–æ–ø–æ–∏—Å–∫–∞
TELEGRAM_TOKEN = os.getenv("7820642533:AAHBkcywBpwzH81Er-21h-ZcwtdnoOgUiTo")      # –¢–æ–∫–µ–Ω –±–æ—Ç–∞

# –°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –∂–∞–Ω—Ä–æ–≤ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
SUPPORTED_GENRES = [
    "–∫–æ–º–µ–¥–∏—è", "–¥—Ä–∞–º–∞", "—É–∂–∞—Å—ã", "—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞", "–±–æ–µ–≤–∏–∫", "—Ç—Ä–∏–ª–ª–µ—Ä",
    "–º–µ–ª–æ–¥—Ä–∞–º–∞", "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è", "–∞–Ω–∏–º–µ", "–¥–µ—Ç–µ–∫—Ç–∏–≤"
]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∂–∞–Ω—Ä–∞–º–∏."""
    keyboard = [[KeyboardButton(genre)] for genre in SUPPORTED_GENRES]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)
    await update.message.reply_text(
        "–ø—Ä–∏–≤–µ—Ç, –Ω–∞–ø–∏—à–∏ –∂–∞–Ω—Ä —Ñ–∏–ª—å–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–º–µ–¥–∏—è), –∏ —è –Ω–∞–π–¥—É –ª—É—á—à–∏–π –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É.",
        reply_markup=reply_markup
    )

async def find_movie(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—â–µ—Ç —Ñ–∏–ª—å–º."""
    genre = update.message.text.lower().strip()

    if genre not in SUPPORTED_GENRES:
        await update.message.reply_text("–Ø –Ω–µ –∑–Ω–∞—é —Ç–∞–∫–æ–≥–æ –∂–∞–Ω—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!")
        return

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ –∫ API –ö–∏–Ω–æ–ø–æ–∏—Å–∫–∞
    url = "https://api.kinopoisk.dev/v1.4/movie"
    params = {
        "genre.name": genre,
        "rating.kp": "6-10",
        "sortField": "rating.kp",
        "sortType": "-1",
        "limit": 1
    }
    headers = {
        "X-API-Key": "79c50614-6417-4d98-ac80-b7b9915785d5",
        "Accept": "application/json"
    }

    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        query_string = urlencode(params)
        request_url = f"{url}?{query_string}"

        # –°–æ–∑–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å
        req = Request(request_url, headers=headers)
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
        with urlopen(req) as response:
            data = json.loads(response.read().decode('utf-8'))

        if data["docs"]:
            movie = data["docs"][0]
            text = (
                f"üé¨ –õ—É—á—à–∏–π —Ñ–∏–ª—å–º –≤ –∂–∞–Ω—Ä–µ ¬´{genre}¬ª:\n\n"
                f"–ù–∞–∑–≤–∞–Ω–∏–µ: {movie['name']}\n"
                f"–†–µ–π—Ç–∏–Ω–≥: {movie['rating']['kp']}/10\n"
                f"–ì–æ–¥: {movie['year']}\n"
                f"–°—Å—ã–ª–∫–∞: https://www.kinopoisk.ru/film/{movie['id']}"
            )
        else:
            text = "–ø–æ —ç—Ç–æ–º—É –∂–∞–Ω—Ä—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç —Ñ–∏–ª—å–º–æ–≤ —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º –≤—ã—à–µ 6."


    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API: {e}")
        text = (
            "–ø—Ä–æ–∏–∑–æ—à–ª–æ –Ω–µ–¥–æ—Ä–∞–∑—É–º–µ–Ω–∏–µ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ö–∏–Ω–æ–ø–æ–∏—Å–∫—É.\n"
            "–ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π –∂–∞–Ω—Ä."
        )

    await update.message.reply_text(text)

def main():
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if not KINOPOISK_API_KEY:
        logger.error("79c50614-6417-4d98-ac80-b7b9915785d5")
        return
    if not TELEGRAM_TOKEN:
        logger.error("7820642533:AAHBkcywBpwzH81Er-21h-ZcwtdnoOgUiTo")
        return
    
   # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, find_movie))
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...")
    app.run_polling()


if os.name == 'main':
    main()
